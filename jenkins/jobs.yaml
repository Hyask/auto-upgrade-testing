# vim: sw=4 ts=4 et

# Auto Upgrade Testing
# Copyright 2016 Canonical Ltd.

# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 3, as published
# by the Free Software Foundation.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranties of
# MERCHANTABILITY, SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR
# PURPOSE.  See the GNU General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program.  If not, see <http://www.gnu.org/licenses/>.

- project:
    name: auto-upgrade-testing
    # TODO: automatically generate this list, possibly with a blacklist
    profile:
        - precise-trusty.1.0
        - precise-trusty_desktop
        - precise-trusty.script-dir-example
        - precise-trusty
        - ubuntu-trusty-xenial-basic-amd64_qemu
        - ubuntu-trusty-xenial-basic-i386_qemu
        - ubuntu-trusty-xenial-desktop-amd64_qemu
        - ubuntu-trusty-xenial-desktop-i386_qemu
        - ubuntu-wily-xenial-basic-amd64_qemu
        - ubuntu-wily-xenial-basic-i386_qemu
        - ubuntu-wily-xenial-desktop-amd64_qemu
        - ubuntu-wily-xenial-desktop-i386_qemu
        - vivid-wily.1.0
        - vivid-wily_desktop
        - vivid-wily
        - wily-xenial.1.0
    jobs:
        - upgrade_{profile}

- job-template:
    name: upgrade_{profile}
    description: |
        This job runs the upgrade test defined in {profile}
        Defined in lp:auto-upgrade-testing/jenkins/jobs.yaml
    node: venonat-upgrade
    triggers:
        # This runs daily and allows jenkins to stagger the jobs
        - timed: 'H H * * *'
    builders:
        - shell: |
            export BRANCH=lp:auto-upgrade-testing # Until this is packaged, we branch for each run
            export PROFILE_NAME="{profile}.yaml"
            export PROFILE=profiles/$PROFILE_NAME

            export BRANCH_DIR=$WORKSPACE/auto-upgrade-testing
            sudo rm -rf $BRANCH_DIR
            bzr branch $BRANCH $BRANCH_DIR
            cd $BRANCH_DIR

            sudo python3 -m upgrade_testing.command_line -c $PROFILE --provision
